import QtQuick
import Quickshell
import Quickshell.Wayland
import Quickshell.Hyprland
import qs.config
import qs.modules.bar.workspaces

Item {
    id: root

    required property ShellScreen targetScreen

    readonly property alias frameEnabled: frameContent.frameEnabled
    readonly property alias baseThickness: frameContent.thickness
    readonly property bool hasFullscreenWindow: {
        const toplevel = ToplevelManager.activeToplevel;
        if (!toplevel || !toplevel.activated)
            return false;
        return toplevel.fullscreen === true;
    }
    readonly property alias actualFrameSize: frameContent.actualFrameSize
    readonly property int thickness: hasFullscreenWindow ? 0 : baseThickness

    readonly property alias innerRadius: frameContent.innerRadius
    readonly property bool containBar: Config.bar?.containBar ?? false

    readonly property string barPos: Config.bar?.position ?? "top"
    // Bar height is 44. Total size = Thickness (Outer) + Bar (44) + Thickness (Inner)
    readonly property int barExpansion: 44 + thickness
    readonly property int topThickness: hasFullscreenWindow ? 0 : (thickness + ((containBar && barPos === "top") ? barExpansion : 0))
    readonly property int bottomThickness: hasFullscreenWindow ? 0 : (thickness + ((containBar && barPos === "bottom") ? barExpansion : 0))
    readonly property int leftThickness: hasFullscreenWindow ? 0 : (thickness + ((containBar && barPos === "left") ? barExpansion : 0))
    readonly property int rightThickness: hasFullscreenWindow ? 0 : (thickness + ((containBar && barPos === "right") ? barExpansion : 0))

    Item {
        id: noInputRegion
        anchors.fill: parent
    }

    PanelWindow {
        id: topFrame
        screen: root.targetScreen
        visible: root.frameEnabled
        implicitHeight: root.topThickness
        height: root.topThickness
        color: "transparent"
        anchors {
            left: true
            right: true
            top: true
        }
        WlrLayershell.layer: WlrLayer.Top
        WlrLayershell.keyboardFocus: WlrKeyboardFocus.None
        WlrLayershell.namespace: "quickshell:screenFrame:top"
        
        // Always Normal mode, control zone size directly
        exclusionMode: (root.containBar && root.barPos === "top" && !root.hasFullscreenWindow) ? ExclusionMode.Normal : ExclusionMode.Ignore
        exclusiveZone: (root.containBar && root.barPos === "top" && !root.hasFullscreenWindow) ? root.topThickness : 0

        mask: Region { item: noInputRegion }
    }

    PanelWindow {
        id: bottomFrame
        screen: root.targetScreen
        visible: root.frameEnabled
        implicitHeight: root.bottomThickness
        height: root.bottomThickness
        color: "transparent"
        anchors {
            left: true
            right: true
            bottom: true
        }
        WlrLayershell.layer: WlrLayer.Top
        WlrLayershell.keyboardFocus: WlrKeyboardFocus.None
        WlrLayershell.namespace: "quickshell:screenFrame:bottom"
        
        exclusionMode: (root.containBar && root.barPos === "bottom" && !root.hasFullscreenWindow) ? ExclusionMode.Normal : ExclusionMode.Ignore
        exclusiveZone: (root.containBar && root.barPos === "bottom" && !root.hasFullscreenWindow) ? root.bottomThickness : 0

        mask: Region { item: noInputRegion }
    }

    PanelWindow {
        id: leftFrame
        screen: root.targetScreen
        visible: root.frameEnabled
        implicitWidth: root.leftThickness
        width: root.leftThickness
        color: "transparent"
        anchors {
            top: true
            bottom: true
            left: true
        }
        WlrLayershell.layer: WlrLayer.Top
        WlrLayershell.keyboardFocus: WlrKeyboardFocus.None
        WlrLayershell.namespace: "quickshell:screenFrame:left"
        
        exclusionMode: (root.containBar && root.barPos === "left" && !root.hasFullscreenWindow) ? ExclusionMode.Normal : ExclusionMode.Ignore
        exclusiveZone: (root.containBar && root.barPos === "left" && !root.hasFullscreenWindow) ? root.leftThickness : 0

        mask: Region { item: noInputRegion }
    }

    PanelWindow {
        id: rightFrame
        screen: root.targetScreen
        visible: root.frameEnabled
        implicitWidth: root.rightThickness
        width: root.rightThickness
        color: "transparent"
        anchors {
            top: true
            bottom: true
            right: true
        }
        WlrLayershell.layer: WlrLayer.Top
        WlrLayershell.keyboardFocus: WlrKeyboardFocus.None
        WlrLayershell.namespace: "quickshell:screenFrame:right"
        
        exclusionMode: (root.containBar && root.barPos === "right" && !root.hasFullscreenWindow) ? ExclusionMode.Normal : ExclusionMode.Ignore
        exclusiveZone: (root.containBar && root.barPos === "right" && !root.hasFullscreenWindow) ? root.rightThickness : 0

        mask: Region { item: noInputRegion }
    }

    PanelWindow {
        id: frameOverlay
        screen: root.targetScreen
        visible: root.frameEnabled
        color: "transparent"
        anchors {
            top: true
            bottom: true
            left: true
            right: true
        }
        WlrLayershell.layer: WlrLayer.Top
        WlrLayershell.keyboardFocus: WlrKeyboardFocus.None
        WlrLayershell.namespace: "quickshell:screenFrame:overlay"
        exclusionMode: ExclusionMode.Ignore
        exclusiveZone: 0
        mask: Region { item: noInputRegion }

        ScreenFrameContent {
            id: frameContent
            anchors.fill: parent
            targetScreen: root.targetScreen
        }
    }
}
